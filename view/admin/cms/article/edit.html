{extend name="admin/layout" /}

{block name="style"}
<link href="https://unpkg.com/@wangeditor/editor@latest/dist/css/style.css" rel="stylesheet">
<style>
  #editor-wrapper { border: 1px solid #ccc; z-index: 100; height: 500px; }
  #toolbar-container { border-bottom: 1px solid #ccc; }
</style>
{/block}

{block name="header"}
    {if empty($article)}New Article{else/}Edit Article{/if}
{/block}

{block name="content"}
<form id="articleForm">
    <input type="hidden" name="id" value="{$article.id|default=''}">
    <input type="hidden" name="content" id="contentInput">
    
    <div class="row">
        <!-- Main Content -->
        <div class="col-md-9">
            <div class="card">
                <div class="card-body">
                    <div class="form-group">
                        <label>Title</label>
                        <input type="text" name="title" class="form-control form-control-lg" value="{$article.title|default=''}" required placeholder="Article Title">
                    </div>
                    
                    <div class="form-group">
                        <label>Content</label>
                        <div id="toolbar-container"></div>
                        <div id="editor-wrapper"></div>
                    </div>
                </div>
            </div>
            
            <!-- SEO Settings -->
            <div class="card collapsed-card">
                <div class="card-header">
                    <h3 class="card-title">SEO Settings</h3>
                    <div class="card-tools">
                        <button type="button" class="btn btn-tool" data-card-widget="collapse"><i class="fas fa-plus"></i></button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <label>Short Title</label>
                        <input type="text" name="short_title" class="form-control" value="{$article.short_title|default=''}">
                    </div>
                    <div class="form-group">
                        <label>Keywords</label>
                        <input type="text" name="seo_keywords" class="form-control" value="{$article.seo_keywords|default=''}">
                    </div>
                    <div class="form-group">
                        <label>Description (Summary)</label>
                        <textarea name="desc" class="form-control">{$article.desc|default=''}</textarea>
                        <small class="text-muted">Empty will auto-extract from content</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sidebar Settings -->
        <div class="col-md-3">
            <div class="card">
                <div class="card-header bg-info">
                    <h3 class="card-title">Publish</h3>
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <label>Category</label>
                        <select name="cid" class="form-control" required>
                            <option value="">Select Category...</option>
                            {volist name="cates" id="vo"}
                            <option value="{$vo.id}" {if isset($article.cid) && $article.cid==$vo.id}selected{/if}>{$vo.name}</option>
                             {if isset($vo.children)}
                                {volist name="vo.children" id="sub"}
                                <option value="{$sub.id}" {if isset($article.cid) && $article.cid==$sub.id}selected{/if}>&nbsp;&nbsp;├─ {$sub.name}</option>
                                {/volist}
                            {/if}
                            {/volist}
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Status</label>
                        <select name="status" class="form-control">
                            <option value="1" {if isset($article.status) && $article.status==1}selected{/if}>Published</option>
                            <option value="0" {if isset($article.status) && $article.status===0}selected{/if}>Draft</option>
                        </select>
                    </div>
                    <button type="button" class="btn btn-primary btn-block" onclick="saveArticle()">
                        <i class="fas fa-save"></i> Save Article
                    </button>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Cover Image</h3>
                </div>
                <div class="card-body">
                    <div class="input-group mb-2">
                         <input type="text" name="thumb" id="thumbInput" class="form-control" value="{$article.thumb|default=''}" placeholder="Image URL">
                    </div>
                    <div class="input-group">
                        <div class="custom-file">
                            <input type="file" class="custom-file-input" id="thumbUpload">
                            <label class="custom-file-label">Choose file</label>
                        </div>
                    </div>
                    <div id="thumbPreview" class="mt-2 text-center">
                        {if !empty($article.thumb)}<img src="{$article.thumb}" style="max-width:100%">{/if}
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Attributes</h3>
                </div>
                 <div class="card-body">
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input" name="is_top" value="1" {if !empty($article.is_top)}checked{/if}>
                        <label class="form-check-label">Top</label>
                    </div>
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input" name="is_hot" value="1" {if !empty($article.is_hot)}checked{/if}>
                        <label class="form-check-label">Hot</label>
                    </div>
                 </div>
            </div>
        </div>
    </div>
</form>
{/block}

{block name="script"}
<div id="init-content" style="display:none">{$content|raw|default=''}</div>
<script src="https://unpkg.com/@wangeditor/editor@latest/dist/index.js"></script>
<script>
    // Wrapper to avoid global scope pollution and ensure DOM ready
    $(function() {
        const createEditor = window.wangEditor.createEditor;
        const createToolbar = window.wangEditor.createToolbar;

        const editorConfig = {
            placeholder: 'Type content here...',
            onChange(editor) {
                const html = editor.getHtml();
                $('#contentInput').val(html);
            },
            MENU_CONF: {
                uploadImage: {
                    server: "{:url('ajax/upload')}",
                    fieldName: 'file',
                    maxFileSize: 10 * 1024 * 1024,
                    allowedFileTypes: ['image/*'],
                }
            }
        };

        const editor = createEditor({
            selector: '#editor-wrapper',
            html: $('#init-content').html(), // Safer way to load convert
            config: editorConfig,
            mode: 'default',
        });

        const toolbar = createToolbar({
            editor,
            selector: '#toolbar-container',
            config: {},
            mode: 'default',
        });
        
        // File Upload for Cover
        $('#thumbUpload').change(function() {
            let formData = new FormData();
            formData.append('file', this.files[0]);
            
            $(this).next('.custom-file-label').html('Uploading...');
            
            $.ajax({
                url: "{:url('ajax/upload')}",
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function(res) {
                     if (res.errno === 0) {
                         let url = res.data[0].url;
                         $('#thumbInput').val(url);
                         $('#thumbPreview').html('<img src="' + url + '" style="max-width:100%">');
                         $('.custom-file-label').html('Choose file');
                     } else {
                         alert(res.message || 'Upload failed');
                     }
                },
                error: function() {
                    alert('Server Error');
                }
            });
        });

        // Global function for Save button
        window.saveArticle = function() {
            // Ensure content is synced
            $('#contentInput').val(editor.getHtml());
            
            $.post("{:url('cms.article/save')}", $('#articleForm').serialize(), function(res) {
                if (res.code == 1) {
                    alert('Saved!');
                    if(res.url) window.location.href = res.url;
                } else {
                    alert(res.msg);
                }
            });
        };
    });
</script>
{/block}
