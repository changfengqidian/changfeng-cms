{extend name="admin/layout" /}

{block name="header"}Tag Management{/block}

{block name="content"}
<div class="card">
    <div class="card-header">
        <form class="form-inline" onsubmit="return false;">
            <input type="text" id="searchInput" class="form-control mr-2" placeholder="Search Tag...">
            <button class="btn btn-default" onclick="loadTags()"><i class="fas fa-search"></i></button>
            <button class="btn btn-primary ml-auto" onclick="addTag()"><i class="fas fa-plus"></i> Add Tag</button>
        </form>
    </div>
    <div class="card-body p-0">
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Name</th>
                    <th>Count</th>
                    <th>Create Time</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody id="tagTable"></tbody>
        </table>
    </div>
</div>

<!-- Modal -->
<div class="modal fade" id="modal-tag">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">Edit Tag</h4>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="tagForm">
                    <input type="hidden" name="id">
                    <div class="form-group">
                        <label>Tag Name</label>
                        <input type="text" name="name" class="form-control" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" onclick="saveTag()">Save</button>
            </div>
        </div>
    </div>
</div>
{/block}

{block name="script"}
<script>
    $(function() {
        loadTags();
    });

    function loadTags() {
        let name = $('#searchInput').val();
        $.get("{:url('cms.tag/index')}", {name: name}, function(res) {
            let html = '';
            res.data.forEach(item => {
                let date = new Date(item.create_time * 1000).toLocaleDateString();
                html += `<tr>
                    <td>${item.id}</td>
                    <td>${item.name}</td>
                    <td><span class="badge badge-info">${item.count}</span></td>
                    <td>${date}</td>
                    <td>
                        <button class="btn btn-xs btn-info" onclick='editTag(${JSON.stringify(item)})'>Edit</button>
                        <button class="btn btn-xs btn-danger" onclick="delTag(${item.id})">Delete</button>
                    </td>
                </tr>`;
            });
            $('#tagTable').html(html);
        });
    }

    function addTag() {
        $('#tagForm')[0].reset();
        $('[name="id"]').val('');
        $('#modal-tag').modal('show');
    }

    function editTag(item) {
        $('#tagForm')[0].reset();
        $('[name="id"]').val(item.id);
        $('[name="name"]').val(item.name);
        $('#modal-tag').modal('show');
    }

    function saveTag() {
        $.post("{:url('cms.tag/save')}", $('#tagForm').serialize(), function(res) {
            if (res.code == 1) {
                $('#modal-tag').modal('hide');
                loadTags();
            } else {
                alert(res.msg);
            }
        });
    }

    function delTag(id) {
        if(confirm('Delete this tag?')) {
            $.post("{:url('cms.tag/delete')}", {id: id}, function(res) {
                loadTags();
            });
        }
    }
</script>
{/block}
